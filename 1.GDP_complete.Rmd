---
title: "1.c-Data_from_cansim_GDP"
author: "Raven Wheesk"
date: "6/17/2022"
output: html_document
---

# Data Provider

Statistics Canada hosts a large set of socio-economic [datasets](https://www150.statcan.gc.ca/n1//en/type/data?MM=1#tables). 


# Basic libraries and R version

```{R, message = FALSE, warning = FALSE}
library(tidyverse) # for its nice flow.
library(cansim) #for pulling Stat Can socioeconomic data
library(lubridate) # for dealing with dates
library(GGally) # for pairs plot
library(ggpubr) # for putting a regression equation onto a ggplot figure
library(glue)   # used for dynamic variable construction
library(dplyr)  # for data manipulation

# set up data location:
location = "R:/res/wher/Google_Climate_Dataset/"
```

```{R version}
version
```

# Loading data
```{r loaddata, echo = FALSE}
# loading from here to avoid re-downloading
load("Total_hours_and_GDP.Rdata")
```

#Variable lists
```{r andrevalues, cache = TRUE}

NAICS_higher_levels = c(
"All industries [T001]",
"Agriculture, forestry, fishing and hunting [11]",
"Mining, quarrying, and oil and gas extraction [21]",	
"Utilities [22]",
"Construction [23]",
"Manufacturing [31-33]",
"Wholesale trade [41]",
"Retail trade [44-45]",
"Transportation and warehousing [48-49]",
"Information and cultural industries [51]",
"Finance and insurance [52]",
"Real estate and rental and leasing [53]",
"Professional, scientific and technical services [54]",
"Management of companies and enterprises [55]",
"Administrative and support, waste management and remediation services [56]",
"Educational services [61]",
"Health care and social assistance [62]",
"Arts, entertainment and recreation [71]",
"Accommodation and food services [72]",
"Other services (except public administration) [81]",
"Public administration [91]")

GDP.variables = c("Utilities..22.",
      "Construction..23.",                                  
      "Manufacturing..31.33.",  
      "Transportation.and.warehousing..48.49.", 
      "Educational.services..61.",                      
      "Health.care.and.social.assistance..62.",
      "Accommodation.and.food.services..72.",
      "Other.services..except.public.administration...81.",
      "Public.administration..91.",
      "Agriculture..forestry..fishing.and.hunting..11.mining.21",
      "Wholesale.and.retail.trade..41..44.45.",
      "Finance..insurance..real.estate..rental.and.leasing..52.53.",
      "Professional..scientific.and.technical.services..54.", 
      "Information..culture.and.recreation..51..71.")

SIC_NAICS_common = c(
  "All industries",
  "Agricultural and related services industries",
  "Fishing and trapping industries",
  "Logging and forestry industries",
  "Mining (including milling), quarrying and oil well industries",
  "Manufacturing industries",
  "Construction industries",
  "Transportation and storage industries",
  "Communication industries",
  "Other utility industries",
  "Wholesale trade industries",
  "Retail trade industries",
  "Finance, insurance and real estate industries",
  "Business services industries",
  "Government service industries",
  "Educational service industries",
  "Health and social service industries",
  "Accommodation, food and beverage service industries",
  "Other service industries",
  "Amusement and recreational service industries",
  "Postal and courier service industries")

GDPsic.variables = c("Agriculture..forestry..fishing.and.hunting..11.mining.21",
  "Manufacturing.industries",
  "Construction.industries",
  "Transportation.and.warehousing..48.49.",
  "Information..culture.and.recreation..51..71.",
  "Other.utility.industries",
  "Wholesale.and.retail.trade..41..44.45.",
  "Finance..insurance.and.real.estate.industries",
  "Business.services.industries",
  "Government.service.industries",
  "Educational.service.industries",
  "Health.and.social.service.industries",
  "Accommodation..food.and.beverage.service.industries",
  "Other.service.industries") 

```

## First we clean the monthly GDP data (NAICS)

```{r exploreGDP, cache=TRUE}
GDP_wide = 
  GDP %>% 
  filter(GEO =="Canada")%>%
  filter(Seasonal.adjustment=="Seasonally adjusted at annual rates")%>%
  filter(Prices=="Chained (2012) dollars")%>%
  filter(North.American.Industry.Classification.System..NAICS. %in%NAICS_higher_levels)%>%
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS., 
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the NAICS names
```

## Extending Management back to 1997

```{r}
#value of management in dec 2006 x 1 - growth rate of gdp in January 2007 

#create variable for GDP growth rate:
GDP_wide = GDP_wide %>% 
   arrange(Date) %>%
mutate(GDP_growth=All.industries..T001./lag(All.industries..T001.)-1) 

#(1) Looping backward from 2006-12-01:

start     <- as.Date("06-12-01",format="%y-%m-%d")
end   <- as.Date("97-01-01",format="%y-%m-%d")

theDate <- start

while (theDate >= end){
  GDP_wide = GDP_wide %>% mutate(Management.of.companies.and.enterprises..55. = case_when( (Date < as.Date("2007-01-01")) ~ lead(Management.of.companies.and.enterprises..55.)*(1-lead(GDP_growth)),(Date >= as.Date("2007-01-01")) ~ Management.of.companies.and.enterprises..55.))
  theDate <- theDate - 1}

```

# Aggregating some NAICS categories to match SIC and LFS
```{r}
GDP_wide = GDP_wide %>%
  mutate(Agriculture..forestry..fishing.and.hunting..11.mining.21   =  Agriculture..forestry..fishing.and.hunting..11. +Mining..quarrying..and.oil.and.gas.extraction..21.)%>%
  mutate(Wholesale.and.retail.trade..41..44.45.                     = Wholesale.trade..41.+Retail.trade..44.45.)%>%
  mutate(Finance..insurance..real.estate..rental.and.leasing..52.53. = Finance.and.insurance..52.+Real.estate.and.rental.and.leasing..53.)%>%
  mutate(Information..culture.and.recreation..51..71.                = Arts..entertainment.and.recreation..71.+Information.and.cultural.industries..51.)%>%
  mutate(Professional..scientific.and.technical.services..54.       = Management.of.companies.and.enterprises..55.+Administrative.and.support..waste.management.and.remediation.services..56.+Professional..scientific.and.technical.services..54.)

#Dropping unnecessary columns
GDP_wide <- GDP_wide %>% select("GEO", "Date", "year", "month",(contains({GDP.variables})))

# Add sum column:
eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDP_wide = GDP_wide %>%  mutate(All.industries.ours = ", paste({GDP.variables},collapse='+'),")"))
           )
     )
```

## Next, we clean the monthly GDP data (SIC)
```{r}
GDPsic_wide = 
  GDPsic %>% 
  filter(Seasonal.adjustment=="Seasonally adjusted")%>%
  filter(Standard.Industrial.Classification..1980..SIC. %in% SIC_NAICS_common)%>%
  select(GEO,Date,year, month,
               Standard.Industrial.Classification..1980..SIC.,
               VALUE)%>%
  pivot_wider(names_from= Standard.Industrial.Classification..1980..SIC., 
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the SIC names
```


# Aggregating some SIC categories to match NAICS and LFS
```{r}
GDPsic_wide = GDPsic_wide %>%
  mutate(Agriculture..forestry..fishing.and.hunting..11.mining.21 = Agricultural.and.related.services.industries + Fishing.and.trapping.industries + Logging.and.forestry.industries + Mining..including.milling...quarrying.and.oil.well.industries)%>%
  mutate(Wholesale.and.retail.trade..41..44.45. = Wholesale.trade.industries + Retail.trade.industries)%>%
  mutate(Transportation.and.warehousing..48.49. = Transportation.and.storage.industries + Postal.and.courier.service.industries)%>%
  mutate(Information..culture.and.recreation..51..71. = Communication.industries - Postal.and.courier.service.industries + Amusement.and.recreational.service.industries) %>%
mutate(Other.service.industries = Other.service.industries - Amusement.and.recreational.service.industries)

#Dropping unnecessary columns
GDPsic_wide <- GDPsic_wide %>% select("GEO", "Date", "year", "month",(contains({GDPsic.variables})))

# Add sum column:
eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDPsic_wide = GDPsic_wide %>%  mutate(All.industries.ours = ", paste({GDPsic.variables},collapse='+'),")"))
           )
     )
```

## Mapping industry names

```{r}
#Changing column names in GDPsic_wide to match column names in GDP_wide
GDPsic_wide = GDPsic_wide %>%
  mutate(Utilities..22. = Other.utility.industries)%>%
  mutate(Construction..23. = Construction.industries)%>%
  mutate(Manufacturing..31.33. = Manufacturing.industries)%>%
  mutate(Finance..insurance..real.estate..rental.and.leasing..52.53. =
Finance..insurance.and.real.estate.industries)%>%
  mutate(Professional..scientific.and.technical.services..54. = Business.services.industries)%>%
  mutate(Public.administration..91. = Government.service.industries)%>%
  mutate(Educational.services..61. = Educational.service.industries)%>%
  mutate(Health.care.and.social.assistance..62. = Health.and.social.service.industries)%>%
  mutate(Accommodation.and.food.services..72. = Accommodation..food.and.beverage.service.industries)%>%
  mutate(Other.services..except.public.administration...81. = Other.service.industries)

#Dropping unnecessary columns
GDPsic_wide <- GDPsic_wide %>% select("GEO", "Date", "year", "month", (contains({GDP.variables})),"All.industries.ours")

#Changing range of GDPsic_wide:
GDPsic_wide=GDPsic_wide %>% filter(Date >= "1975-12-01" & Date <= "1997-01-01")

```

## Splicing GDP_sic and GDP_wide
```{r}
#Attempt 1
GDP_splice = GDP_wide %>% 
   arrange(Date) %>%
eval(parse(text=
     # view the line of code generated by running with the glue command       
             glue(paste0('GDP_wide %>%arrange(Date)%>% mutate(', paste(paste0(GDP.variables,"_","g","=",GDP.variables, "/", lead(GDP.variables),collapse=","),')')
                        ))))
  #Attempt 2   
 GDP_wide_test <- GDP_wide %>%
 eval(parse(text= glue('GDP_wide_test = GDP_wide_test %>%arrange(Date)%>% mutate(paste("g", {GDP.variables}, sep= "_") = (as.numeric(paste0({GDP.variables}))/(as.numeric(paste0(lead{GDP.variables})))))')
                        ))


while (theDate >= end){
df = df %>% mutate(paste({GDP.variables}, '.y') = case_when( (Date < as.Date("1997-01-01")) ~ paste({GDP.variables}, '.x')/lead(paste({GDP.variables}, '.x'))*lead(paste({GDP.variables}, '.y')),(Date >= as.Date("1997-01-01")) ~ Utilities..22..y))
theDate <- theDate - 1}

GDP_splice = GDP_wide %>% 
   arrange(Date) %>%
eval(parse(text=
     # view the line of code generated by running with the glue command       
             glue(paste0('df %>%arrange(Date)%>% mutate(', paste(paste0(GDP.variables, "=",GDP.variables, "/", lead(GDP.variables),'.x','*',lead(GDP.variables),'.y',collapse=","),')')
                        ))))
  mutate_all()
```

## following chunks testing

```{r}

dates<-seq(from=as.Date("1975-12-01","19%y-%m-%d"),to=as.Date("1996-12-01","19%y-%m-%d"),by="month")

cols <- c('GEO', 'Date', 'year', 'month','Utilities..22.', 'Construction..23.', 'Manufacturing..31.33.', 'Transportation.and.warehousing..48.49.', 'Educational.services..61.', 'Health.care.and.social.assistance..62.', 'Accommodation.and.food.services..72.', 'Other.services..except.public.administration...81.', 'Public.administration..91.', 'Agriculture..forestry..fishing.and.hunting..11.mining.21', 'Wholesale.and.retail.trade..41..44.45.', 'Finance..insurance..real.estate..rental.and.leasing..52.53.', 'Professional..scientific.and.technical.services..54.', 'Information..culture.and.recreation..51..71.', 'All.industries.ours')


GDP_blank <- data.frame(matrix(1, nrow = length(dates), ncol = 19))
names(GDP_blank) <- cols
GDP_blank$Date <- dates

GDP_wide_test <- rbind(GDP_blank, GDP_wide)


```

## cont

```{r}

dates<-seq(from=as.Date("1997-02-01","19%y-%m-%d"),to=as.Date("2022-03-01","20%y-%m-%d"),by="month")

cols <- c('GEO', 'Date', 'year', 'month','Utilities..22.', 'Construction..23.', 'Manufacturing..31.33.', 'Transportation.and.warehousing..48.49.', 'Educational.services..61.', 'Health.care.and.social.assistance..62.', 'Accommodation.and.food.services..72.', 'Other.services..except.public.administration...81.', 'Public.administration..91.', 'Agriculture..forestry..fishing.and.hunting..11.mining.21', 'Wholesale.and.retail.trade..41..44.45.', 'Finance..insurance..real.estate..rental.and.leasing..52.53.', 'Professional..scientific.and.technical.services..54.', 'Information..culture.and.recreation..51..71.', 'All.industries.ours')


GDP_blank1 <- data.frame(matrix(1, nrow = length(dates), ncol = 19))
names(GDP_blank1) <- cols
GDP_blank1$Date <- dates

GDPsic_wide_test <- rbind(GDPsic_wide,GDP_blank1)


```

## cont

```{r}

df <- rbind(GDPsic_wide_test,GDP_wide_test)

df <- GDPsic_wide_test %>%
  inner_join(GDP_wide_test, by=c("Date", "GEO", "year", "month"))
```

## cont

```{r}
# use glue to calculate productivity
eval(parse(text= glue("df = df %>% 
mutate({paste('final', {GDP.variables}, sep = '_')} = (as.numeric({paste0({GDP.variables},'.y')}) /(as.numeric({paste0({GDP.variables},'.x')})))*1000)")))
```


```{r}

#(1) Looping backward from 2006-12-01:

start     <- as.Date("1996-12-01",format="19%y-%m-%d")
end   <- as.Date("1976-01-01",format="19%y-%m-%d")

theDate <- start


while (theDate >= end){
  df = df %>% mutate({paste({GDP.variables},'.y',sep="")} == case_when( (Date < as.Date("1997-01-01")) ~ as.numeric({paste({GDP.variables}, '.x',sep="")})/lead(as.numeric({paste({GDP.variables},'.x',sep="")}))*lead(as.numeric({paste({GDP.variables}, '.y',sep="")})),(Date >= as.Date("1997-01-01")) ~ {paste({GDP.variables},'.y',sep="")}))
  theDate <- theDate - 1}

```



```{r}
#GDP_wide = GDP_wide %>% 
 #  arrange(Date) %>%
#mutate(GDP_growth=All.industries..T001./lag(All.industries..T001.)-1) 

#(1) Looping backward from 2006-12-01:

start     <- as.Date("96-12-01",format="19%y-%m-%d")
end   <- as.Date("76-01-01",format="19%y-%m-%d")

theDate <- start

while (theDate >= end){
  GDP_test = GDP_test %>% mutate(Utilities..22. = case_when( (Date < as.Date("1997-01-01")) ~ 10,(Date >= as.Date("1997-01-01")) ~ Utilities..22.))
  theDate <- theDate - 1}




```


## 2012 constant or chained dollars
Note the decisions that need to be made for GDP include filtering on some variables.  Consider these price options:
```{r exploreGDP, cache=TRUE}

GDPAnnual %>% 
  filter(GEO =="Canada")%>%
  select(Value)%>% table %>% names %>% sort



```


#Reducing down to a smaller set of of values from the NAICS hierarchy.

```{r andrevalues, cache = TRUE}

NAICS_higher_levels = c(
"All industries [T001]",
"Agriculture, forestry, fishing and hunting [11]",
"Mining, quarrying, and oil and gas extraction [21]",	
"Utilities [22]",
"Construction [23]",
"Manufacturing [31-33]",
"Wholesale trade [41]",
"Retail trade [44-45]",
"Transportation and warehousing [48-49]",
"Information and cultural industries [51]",
"Finance and insurance [52]",
"Real estate and rental and leasing [53]",
"Professional, scientific and technical services [54]",
"Management of companies and enterprises [55]",
"Administrative and support, waste management and remediation services [56]",
"Educational services [61]",
"Health care and social assistance [62]",
"Arts, entertainment and recreation [71]",
"Accommodation and food services [72]",
"Other services (except public administration) [81]",
"Public administration [91]")

GDP_wide = 
  GDP %>% 
  filter(Seasonal.adjustment=="Seasonally adjusted at annual rates")%>%
  filter(Prices==dollars2use)%>%
  filter(North.American.Industry.Classification.System..NAICS. %in%NAICS_higher_levels)%>%
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS., 
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the NAICS names

GDPAnnual_wide = 
  GDPAnnual %>% 
  filter(Value==dollars2use)%>%
  filter(North.American.Industry.Classification.System..NAICS. %in%NAICS_higher_levels)%>%
  select(GEO,Date, 
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS., 
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the NAICS names



```

Selecting SIC codes that can be matched with NAICS

```{r andrevalues, cache = TRUE}
SIC_NAICS_common = c(
  "All industries",
  "Agricultural and related services industries",
  "Fishing and trapping industries",
  "Logging and forestry industries",
  "Mining (including milling), quarrying and oil well industries",
  "Manufacturing industries",
  "Construction industries",
  "Transportation and storage industries",
  "Communication industries",
  "Other utility industries",
  "Wholesale trade industries",
  "Retail trade industries",
  "Finance, insurance and real estate industries",
  "Business services industries",
  "Government service industries",
  "Educational service industries",
  "Health and social service industries",
  "Accommodation, food and beverage service industries",
  "Other service industries",
  "Amusement and recreational service industries",
  "Postal and courier service industries")
  
GDPsic_wide = 
  GDPsic %>% 
  filter(Seasonal.adjustment=="Seasonally adjusted")%>%
  filter(Standard.Industrial.Classification..1980..SIC. %in% SIC_NAICS_common)%>%
  select(GEO,Date,year, month,
               Standard.Industrial.Classification..1980..SIC.,
               VALUE)%>%
  pivot_wider(names_from= Standard.Industrial.Classification..1980..SIC., 
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the SIC names

```


## making THW and GDP comparable

Some NAICS categories do not completely overlap across the THW and GDP datasets.  Combine categories accordingly.

```{r}

GDP_wide = GDP_wide %>%
  mutate(Agriculture..forestry..fishing.and.hunting..11.mining.21   =  Agriculture..forestry..fishing.and.hunting..11. +Mining..quarrying..and.oil.and.gas.extraction..21.)%>%
  mutate(Wholesale.and.retail.trade..41..44.45.                     = Wholesale.trade..41.+Retail.trade..44.45.)%>%
  mutate(Finance..insurance..real.estate..rental.and.leasing..52.53. = Finance.and.insurance..52.+Real.estate.and.rental.and.leasing..53.)%>%
  mutate(Information..culture.and.recreation..51..71.                = Arts..entertainment.and.recreation..71.+Information.and.cultural.industries..51.)


GDPAnnual_wide = GDPAnnual_wide %>%
  mutate(Agriculture..forestry..fishing.and.hunting..11.mining.21   =  Agriculture..forestry..fishing.and.hunting..11. +Mining..quarrying..and.oil.and.gas.extraction..21.)%>%
  mutate(Wholesale.and.retail.trade..41..44.45.                     = Wholesale.trade..41.+Retail.trade..44.45.)%>%
  mutate(Finance..insurance..real.estate..rental.and.leasing..52.53. = Finance.and.insurance..52.+Real.estate.and.rental.and.leasing..53.)%>%
  mutate(Professional..scientific.and.technical.services..54.       = Management.of.companies.and.enterprises..55.+Administrative.and.support..waste.management.and.remediation.services..56.+Professional..scientific.and.technical.services..54.)%>%
  mutate(Information..culture.and.recreation..51..71.                = Arts..entertainment.and.recreation..71.+Information.and.cultural.industries..51.)


GDPsic_wide = GDPsic_wide %>%
  mutate(Agriculture..forestry..fishing.and.hunting..11.mining.21 = Agricultural.and.related.services.industries + Fishing.and.trapping.industries + Logging.and.forestry.industries + Mining..including.milling...quarrying.and.oil.well.industries)%>%
  mutate(Wholesale.and.retail.trade..41..44.45. = Wholesale.trade.industries + Retail.trade.industries)%>%
  mutate(Transportation.and.warehousing..48.49. = Transportation.and.storage.industries + Postal.and.courier.service.industries)%>%
  mutate(Information..culture.and.recreation..51..71. = Communication.industries - Postal.and.courier.service.industries + Amusement.and.recreational.service.industries) %>%
mutate(Other.service.industries = Other.service.industries - Amusement.and.recreational.service.industries)


```

### Sanity check for entire sample

```{r}

GDP.variables = c("Utilities..22.",
      "Construction..23.",                                  
      "Manufacturing..31.33.",  
      "Transportation.and.warehousing..48.49.", 
      "Educational.services..61.",                      
      "Health.care.and.social.assistance..62.",
      "Accommodation.and.food.services..72.",
      "Other.services..except.public.administration...81.",
      "Public.administration..91.",
      "Agriculture..forestry..fishing.and.hunting..11.mining.21",
      "Wholesale.and.retail.trade..41..44.45.",
      "Finance..insurance..real.estate..rental.and.leasing..52.53.",
      "Professional..scientific.and.technical.services..54.", 
      "Information..culture.and.recreation..51..71.")

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDP_post1996 = GDP_wide %>%  mutate(All.industries.ours = ", paste({GDP.variables},collapse='+'),")"))
           )
     )


#plot to make sure that our combination = the stated combination
GDP_post1996%>% ggplot()+
  geom_point(aes(x=All.industries.ours, y=All.industries..T001., colour = year))



eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDPAnnual_post1996 = GDPAnnual_wide %>%  mutate(All.industries.ours = ", paste({GDP.variables},collapse='+'),")"))
           )
     )

#now for GDPsic - replace these with SIC codes

GDPSIC.variables = c("Manufacturing.industries", "Construction.industries", "Other.utility.industries", "Finance..insurance.and.real.estate.industries", "Business.services.industries", "Government.service.industries", "Educational.service.industries", "Health.and.social.service.industries", "Accommodation..food.and.beverage.service.industries", "Other.service.industries", "Agriculture..forestry..fishing.and.hunting..11.mining.21", "Wholesale.and.retail.trade..41..44.45.", "Transportation.and.warehousing..48.49.", "Information..culture.and.recreation..51..71.")

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDP_pre1997 = GDPsic_wide %>%  mutate(All.industries.ours = ", paste({GDPSIC.variables},collapse='+'),")"))
           )
     )

#plot to make sure that our combination = the stated combination
GDP_pre1997%>% ggplot()+
  geom_point(aes(x=All.industries.ours, y=All.industries, colour = year))

```

##need to impute values for pre-2007 management - NAICS possible solutions include (1) grow it backwards at the rate of GDP growth (2) regress management 2007- on GDP, use estimated relationship to impute (3) estimate relationship between management and all industries 


```{r}

#(1)
#value of management in dec 2006 x 1 - growth rate of gdp in January 2007 

#create variable for GDP growth rate:
GDP_post1996 = GDP_post1996 %>% 
   arrange(Date) %>%
mutate(GDP_growth=All.industries..T001./lag(All.industries..T001.)-1) 

#(1) Looping backward from 2006-12-01:

start     <- as.Date("06-12-01",format="%y-%m-%d")
end   <- as.Date("97-01-01",format="%y-%m-%d")

theDate <- start

while (theDate >= end){
  GDP_post1996 = GDP_post1996 %>% mutate(Management.of.companies.and.enterprises..55. = case_when( (Date < as.Date("2007-01-01")) ~ lead(Management.of.companies.and.enterprises..55.)*(1-lead(GDP_growth)),(Date >= as.Date("2007-01-01")) ~ Management.of.companies.and.enterprises..55.))
  theDate <- theDate - 1}

GDP_post1996 = GDP_post1996 %>% 
 mutate(Professional..scientific.and.technical.services..54.       = Management.of.companies.and.enterprises..55.+Administrative.and.support..waste.management.and.remediation.services..56.+Professional..scientific.and.technical.services..54.)

 eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("GDP_post1996 = GDP_post1996 %>%  mutate(All.industries.ours = ", paste({GDP.variables},collapse='+'),")"))
           )
     )
 


#we now have a complete GDP_post1996 table with no NA values
 

 
```


### Check which variables were now left out from crafting our total
Compare these to the list in the previous chunk that was used to build **totals.hours.ours**.  Note that above, some of these _leftover_ variables were already used (eg. mining + agriculture).

```{r}
# for book keeping
setdiff(colnames(GDP_post1996),GDP.variables)
setdiff(colnames(GDP_pre1997),GDPSIC.variables)
```

## Save the modified data sets:
```{r}

GDP_post1996       %>% write_csv(file = paste0(location,"1.c-Data_From_Cansim-GDP.csv"))
GDPAnnual_post1996 %>% write_csv(file = paste0(location,"1.c-Data_From_Cansim-GDPAnnual.csv"))
GDP_pre1997       %>% write_csv(file = paste0(location,"1.c-Data_From_Cansim-GDPretro.csv"))

save("GDP_post1996", "GDPAnnual_post1996", "GDP_pre1997", "GDP.variables", "GDPSIC.variables",
file = paste0(location,"1.c-Data_From_Cansim-GDP_and_total_hours_worked.Rdata"))
```



