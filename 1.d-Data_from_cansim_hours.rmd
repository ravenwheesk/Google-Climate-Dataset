---
title: "1.d-Data_from_cansim_hours"
author: "Raven Wheesk"
date: "6/17/2022"
output: html_document
---

# Data Provider

Statistics Canada hosts a large set of socio-economic [datasets](https://www150.statcan.gc.ca/n1//en/type/data?MM=1#tables). 


# Basic libraries and R version

```{R, message = FALSE, warning = FALSE}
library(tidyverse) # for its nice flow.
library(cansim) #for pulling Stat Can socioeconomic data
library(lubridate) # for dealing with dates
library(GGally) # for pairs plot
library(ggpubr) # for putting a regression equation onto a ggplot figure
library(glue)   # used for dynamic variable construction
library(dplyr)  # for data manipulation

# set up data location:
location = "R:/res/wher/Google_Climate_Dataset/"
```

```{R version}
version
```

# Loading data
```{r loaddata, echo = FALSE}
# loading from here to avoid re-downloading
load("Total_hours_and_GDP.Rdata")
```


```{r, widendata,  cache = TRUE}


THW_wide = THW%>%filter(Sex == "Both sexes") %>% 
  filter(Class.of.worker == "Total employed")%>%
  filter(Actual.hours.worked == "Total actual hours (main job)")%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Goods.producing.sector" )%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Services.producing.sector" )%>%
  #filter(GEO != "Canada")%>% # since the Canada value will be a type of weighted average
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS.,
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the province names


THWSA_wide = THWSA%>% 
  filter(Statistics == "Estimate")%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Goods.producing.sector" )%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Services.producing.sector" )%>%
  #filter(GEO != "Canada")%>% # since the Canada value will be a type of weighted average
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS.,
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the province names


# Employment - need seasonally adjusted and non-seasonally adjusted

EMPSA_wide = EMP%>% 
  filter(Statistics == "Estimate")%>%
  filter(Data.type == "Seasonally adjusted")%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Goods.producing.sector" )%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Services.producing.sector" )%>%
  #filter(GEO != "Canada")%>% # since the Canada value will be a type of weighted average
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS.,
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the province names

##

EMPNSA_wide = EMP%>%
  filter(Statistics == "Estimate")%>%
  filter(Data.type == "Unadjusted")%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Goods.producing.sector" )%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Services.producing.sector" )%>%
  #filter(GEO != "Canada")%>% # since the Canada value will be a type of weighted average
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS.,
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the province names



```


### This time with Total Hours Worked and employment

```{r}


THW.variables = c(
  "Agriculture..111.112..1100..1151.1152.",
  "Forestry..fishing..mining..quarrying..oil.and.gas..21..113.114..1153..2100.",
  "Utilities..22.",
  "Construction..23.",
  "Manufacturing..31.33.",
  "Wholesale.and.retail.trade..41..44.45.",
  "Transportation.and.warehousing..48.49.",
  "Finance..insurance..real.estate..rental.and.leasing..52.53.",
  "Professional..scientific.and.technical.services..54.", 
  "Business..building.and.other.support.services..55.56.",
  "Educational.services..61.",
  "Health.care.and.social.assistance..62.",
  "Information..culture.and.recreation..51..71.",               
  "Accommodation.and.food.services..72.",
  "Other.services..except.public.administration...81.",             
  "Public.administration..91.")


eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("THW_post1986 = THW_wide %>% mutate(totals.hours.ours = ", paste({THW.variables},collapse='+'),")"))
           )
     )

#plot to make sure that our combination = the stated combination
THW_post1986 %>% ggplot()+
  geom_point(aes(x=totals.hours.ours, y=Total.employed..all.industries, colour = GEO))+
  geom_abline(slope=1,intercept=0)

THW_post1986 <- THW_post1986 %>% select(-contains(".sector"))

# Repeat for others:

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("THWSA_post1986 = THWSA_wide %>% mutate(totals.hours.ours = ", paste({THW.variables},collapse='+'),")"))
           )
     )


THWSA_post1986 <- THWSA_post1986 %>% select(-contains(".sector"))


#

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("EMPSA_post1986 = EMPSA_wide %>% mutate(totals.emp.ours = ", paste({THW.variables},collapse='+'),")"))
           )
     )

EMPSA_post1986 <- EMPSA_post1986 %>% select(-contains(".sector"))

#

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("EMPNSA_post1986 = EMPNSA_wide %>% mutate(totals.emp.ours = ", paste({THW.variables},collapse='+'),")"))
           )
     )

EMPNSA_post1986 <- EMPNSA_post1986 %>% select(-contains(".sector"))


```


```{r}
# for book keeping
setdiff(colnames(THW_post1986),THW.variables)
```
## We need to create a seasonal factor for employment 

```{r}


EMPSA1 <- subset (EMPSA_post1986, select = -c(GEO,Date,year,month))
EMPNSA1 <- subset (EMPNSA_post1986, select = -c(GEO,Date,year,month))
info_columns <- subset (EMPSA_post1986, select = c(GEO,Date,year,month))

EMPSF_post1986 <- cbind(info_columns, EMPSA1/EMPNSA1)

EMPSF_post1986 <- subset(EMPSF_post1986, Date > as.Date("1986-12-01"))



```

## We need a seasonal factor for THW for Canada

```{r}
# Create seasonal factor for Canada by hours

THWNSA_wide = THW%>%filter(Sex == "Both sexes") %>% 
  filter(Class.of.worker == "Total employed")%>%
  filter(Actual.hours.worked == "Total actual hours (main job)")%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Goods.producing.sector" )%>%
  filter(North.American.Industry.Classification.System..NAICS.!= "Services.producing.sector" )%>%
  filter(GEO == "Canada")%>% 
  select(GEO,Date,year, month,
               North.American.Industry.Classification.System..NAICS.,
               VALUE)%>%
  pivot_wider(names_from= North.American.Industry.Classification.System..NAICS.,
              values_from=VALUE) %>%  # puts each province into its own column
  rename_all(make.names) # rebuilt the province names

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0("THWNSA_post1986 = THWNSA_wide %>% mutate(totals.hours.ours = ", paste({THW.variables},collapse='+'),")"))
           )
     )

THWNSA_post1986 <- THWNSA_post1986 %>% select(-contains(".sector"))


THWSA1 <- subset (THWSA_post1986, Date > as.Date("1986-12-01"), select = -c(GEO,Date,year,month))
THWNSA1 <- subset (THWNSA_post1986, select = -c(GEO,Date,year,month))
info_columns <- subset (THWNSA_post1986, select = c(GEO,Date,year,month))

THWSF_post1986 <- cbind(info_columns, THWSA1/THWNSA1)

# get rid of spaces in province names

THWSF_post1986 = THWSF_post1986 %>%
mutate(GEO=str_replace_all(GEO,pattern=" ", replacement="."))

EMPSF_post1986 = EMPSF_post1986 %>%
mutate(GEO=str_replace_all(GEO,pattern=" ", replacement="."))

THW_post1986 = THW_post1986 %>%
mutate(GEO=str_replace_all(GEO,pattern=" ", replacement="."))

province_index = select(EMPSF_post1986, GEO)%>%unique()


```

## We want to reshape the long SF tables into  wide table

```{r}
EMPSF_post1986 <- pivot_wider(EMPSF_post1986, names_from = "GEO", values_from =c(contains(".")))

EMPSF_post1986 <- EMPSF_post1986 %>% select(-contains("year"))
EMPSF_post1986 <- EMPSF_post1986 %>% select(-contains("month"))

#

THWSF_post1986 <- pivot_wider(THWSF_post1986, names_from = "GEO", values_from =c(contains(".")))

THWSF_post1986 <- THWSF_post1986 %>% select(-contains("year"))
THWSF_post1986 <- THWSF_post1986 %>% select(-contains("month"))

# 

THW_post1986 <- pivot_wider(THW_post1986, names_from = "GEO", values_from =c(contains(".")))

THW_post1986 <- THW_post1986 %>% select(-contains("year"))
THW_post1986 <- THW_post1986 %>% select(-contains("month"))




# Take THW_post1986 dataframe, multiply it by the ratio of two columns in the EMPSF_post1986 dataframe - (NAICS_prov/NAICS_Canada)*THW_post1986
# make a for loop over province

eval(parse(text=
     # view the line of code generated by running with the glue command       
             glue(paste0('EMPSF_ratio = EMPSF_post1986 %>% select(',paste0({THW.variables},"_", province_index, "/", {THW.variables},'_', "Canada"),')')
                  )
)
)

eval(parse(text=
     # view the line of code generated by running with the glue command        
             glue(paste0('EMPSF_ratio = EMPSF_post1986 %>% select(', paste(paste0("EMPSF_",THW.variables,"=",THW.variables,"_Ontario"), "/", THW.variables,"_Canada"),collapse=","),')')
     )
     )


      
### Other option: use glue and mutate to create new columns that are EMPSF_industry_province, then subset 

eval(parse(text=
     # view the line of code generated by running with the glue command       
             glue(paste0('EMPSF_post1986 %>% mutate(', paste(paste0("EMPSF","_",THW.variables,"=",THW.variables,"_","Ontario"), "/", THW.variables,"_","Canada"),collapse=","),')')
     ))


  
```

## Now, using the employment and hours seasonal factors, we can create a final seasonal adjustment factor for each province - note, THWSF is only at the national level

```{r}

THW_test <- subset (THW_post1986, Date > as.Date("2021-12-01"), select = c(Date, Agriculture..111.112..1100..1151.1152._Canada, Agriculture..111.112..1100..1151.1152._Ontario, Agriculture..111.112..1100..1151.1152._Quebec))

THWSF_test <- subset (THWSF_post1986, Date > as.Date("2021-12-01"), select = c(Date, Agriculture..111.112..1100..1151.1152._Canada))


EMPSF_test <- subset (EMPSF_post1986, Date > as.Date("2021-12-01"), select = c(Date, Agriculture..111.112..1100..1151.1152._Canada, Agriculture..111.112..1100..1151.1152._Ontario, Agriculture..111.112..1100..1151.1152._Quebec))

dftest <- THW_test["Agriculture..111.112..1100..1151.1152._Ontario"]*THWSF_test["Agriculture..111.112..1100..1151.1152._Canada"]*EMPSF_test[3]/EMPSF_test[2]

THW_test <- subset (THW_post1986, Date > as.Date("2021-12-01"), select = c(Date, select(c(contains("Agriculture.", "Manufacturing.")))))


select(THW_test,matches("Ontario") & matches ("Agriculture"))

clist <- c("Ontario", "Quebec")
for (i in clist) {
THW_test[i] <- select(THW_test,contains(i))
   }


select(c(-contains("Canada")))
select(c(contains("Canada")))




SF_post1986 = THWSF_post1986

```